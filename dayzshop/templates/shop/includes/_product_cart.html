{% load static %}
{% load cart_tags %}

<div class="col-12 col-md-6 mb-4">
    <div class="card h-100 d-flex flex-column position-relative overflow-hidden">
        <div class="card-shine-effect"></div>
        <div class="cart-image-container">
            <a href="{{ product.get_absolute_url }}" 
            class="flex-grow-1 d-flex align-items-center justify-content-center p-2 position-relative"
            style="z-index: 2;">
                {% if product.image %}
                <img src="{{ product.image.url }}" 
                    class="card-img-top img-fluid mx-auto" 
                    alt="{{ product.name }}">
                {% else %}
                <img src="{% static 'img/no-image.jpg' %}" 
                    class="card-img-top img-fluid" 
                    alt="No image" 
                    style="height: 180px; object-fit: cover; opacity: 0.8;">
                {% endif %}
            </a>
        </div>
        <div class="card-body d-flex flex-column" style="background-color: transparent; z-index: 1;">
            <!-- Категория -->
            <span class="badge cart_category_badge mb-2 align-self-start">
                {{ product.category.name|default:"Без категории" }}
            </span>
            <!-- Название и цена в одной строке -->
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="product-name-wrapper" style="max-width: 70%; max-height: 20px;">
                    <h5 class="card-title mb-0 text-white">
                        <span class="product-name">{{ product.name }}</span>
                    </h5>
                </div>
                <div class="product-price">
                    {% if product.is_on_sale and product.old_price %}
                        <span class="text-danger">{{ product.price|floatformat:"0" }} ₽</span>
                        <span class="text-decoration-line-through text-muted small ms-2">
                            {{ product.old_price|floatformat:"0" }} ₽
                        </span>
                        <span class="badge bg-danger ms-2">
                            -{{ product.discount_percentage }}%
                        </span>
                    {% else %}
                        <span>{{ product.price|floatformat:"0" }} ₽</span>
                    {% endif %}
                </div>
                {% comment %} <span class="h6 mb-0 price-badge">{{ product.price }} ₽</span> {% endcomment %}
            </div>
            <!-- Описание -->
            <p class="text-muted small mb-3" style="
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                height: 2.4em;
                line-height: 1.2em;
            ">
                {{ product.description|default:"Описание отсутствует" }}
            </p>
            <!-- Характеристики -->
            <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded p-2 mb-3">
                <ul class="list-unstyled mb-0 small" style="line-height: 1.4;">
                    {% for spec in product.specifications.all|slice:":3" %}
                    <li><span class="text-success">{{ spec.name }}:</span> {{ spec.value }}</li>
                    {% empty %}
                    <li class="text-muted">Характеристики не указаны</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card-actions mt-auto">
                <button 
                    class="btn add-to-cart-btn {% if product|is_in_cart:request %}added-to-cart{% endif %}" 
                    data-product-id="{{ product.id }}"
                    {% if product|is_in_cart:request %}data-is-in-cart="true"{% endif %}>
                    {% if product|is_in_cart:request %}
                        <i class="bi bi-check-circle-fill"></i> В корзине
                    {% else %}
                        <i class="bi bi-cart-plus"></i> В корзину
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

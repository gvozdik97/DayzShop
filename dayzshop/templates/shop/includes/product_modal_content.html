{% load static %}
{% load humanize %}
{% load cart_tags %}

<div class="row g-4">
    
    <!-- Левая колонка: Изображение -->
    <div class="col-lg-6">
        <div class="product-modal-image-container">
            {% if product.image %}
                <img src="{{ product.image.url }}" 
                    alt="{{ product.name }}" 
                    class="product-modal-image">
            {% else %}
                <img src="{% static 'img/no-image.jpg' %}" 
                    alt="No image" 
                    class="product-modal-image">
            {% endif %}

            <!-- Бейдж скидки -->
            {% if product.is_on_sale and product.old_price %}
                <div class="product-badges position-absolute top-0 start-0 mt-2 mx-2 d-flex flex-column gap-2">
                    <span class="product-modal-discount-badge badge">
                        -{{ product.discount_percentage }}%
                    </span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Правая колонка: Информация -->
    <div class="col-lg-6 d-flex flex-column" style="min-height: 100%; padding: 0.5rem 1rem 0.5rem 3.5rem;">
        
        <!-- Контент, который растягивается -->
        <div class="flex-grow-1">
            <!-- Категория -->
            <div>
                <span class="product-modal-category">
                    {{ product.category.name|default:"Без категории" }}
                </span>
            </div>
            
            <!-- Название товара -->
            <h2 class="product-modal-title">
                {{ product.name }}
            </h2>

            <!-- Рейтинг -->
            <div class="product-modal-rating-container">
                <div class="product-modal-stars">
                    <i data-lucide="star" class="product-modal-star filled"></i>
                    <i data-lucide="star" class="product-modal-star filled"></i>
                    <i data-lucide="star" class="product-modal-star filled"></i>
                    <i data-lucide="star" class="product-modal-star filled"></i>
                    <i data-lucide="star" class="product-modal-star"></i>
                </div>
                <span class="product-modal-rating-text">4.8</span>
                <span class="product-modal-rating-count">(24 отзыва)</span>
            </div>
            
            <!-- Описание -->
            <p class="product-modal-description">
                {{ product.description|default:"Описание отсутствует" }}
            </p>

            <!-- Цена -->
            <div class="product-modal-price-container">
                <div class="d-flex align-items-baseline">
                    <span class="product-modal-current-price">{{ product.price|floatformat|intcomma }} ₽</span>
                    {% if product.is_on_sale and product.old_price %}
                        <span class="product-modal-original-price">{{ product.old_price|floatformat|intcomma }} ₽</span>
                    {% endif %}
                </div>
                {% if product.is_on_sale and product.old_price %}
                    <div class="product-modal-price-savings">
                        Экономия: {{ product.savings|floatformat|intcomma }} ₽
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="mt-auto pt-4">
            <div class="d-flex gap-3">
                <!-- ОБНОВЛЕННАЯ КНОПКА КОРЗИНЫ -->
                <button 
                    class="btn add-to-cart-btn w-100 py-3 d-flex align-items-center justify-content-center {% if product|is_in_cart:request %}added-to-cart{% endif %}" 
                    style="flex: 1; min-width: 0; height: 3rem;"
                    data-product-id="{{ product.id }}"
                    {% if product|is_in_cart:request %}data-is-in-cart="true"{% endif %}
                    id="modalAddToCartBtn"
                >
                    {% if product|is_in_cart:request %}
                        <i class="bi bi-check-circle-fill lucide-icon-sm"></i> В корзине
                    {% else %}
                        <i class="bi bi-cart2 lucide-icon-sm"></i> В корзину
                    {% endif %}
                </button>

                <form method="post" action="{% url 'shop:toggle_wishlist' product.id %}" class="wishlist-form mb-0">
                    {% csrf_token %}
                    <button type="button" 
                            class="btn btn-secondary-custom favorite-btn d-flex align-items-center justify-content-center p-0" 
                            id="modalFavoriteBtn"
                            style="width: 3rem; height: 3rem;"
                            data-product-id="{{ product.id }}"
                            data-in-wishlist="{% if request.user.is_authenticated and product.in_wishlist %}true{% else %}false{% endif %}"
                            title="{% if request.user.is_authenticated and product.in_wishlist %}Удалить из избранного{% else %}Добавить в избранное{% endif %}">
                        <i data-lucide="heart" class="lucide-icon-sm {% if request.user.is_authenticated and product.in_wishlist %}fill: currentColor;{% endif %}"
                        {% if request.user.is_authenticated and product.in_wishlist %}fill="currentColor"{% endif %}></i>
                    </button>
                </form>
                {% comment %} <button type="button" 
                        class="btn btn-secondary-custom btn-favorite d-flex align-items-center justify-content-center p-0" 
                        id="modalFavoriteBtn"
                        style="width: 3rem; height: 3rem;"
                        data-product-id="{{ product.id }}"
                        data-in-wishlist="{% if request.user.is_authenticated and product.in_wishlist %}true{% else %}false{% endif %}"
                        title="{% if request.user.is_authenticated and product.in_wishlist %}Удалить из избранного{% else %}Добавить в избранное{% endif %}">
                    <i data-lucide="heart" class="lucide-icon-sm {% if request.user.is_authenticated and product.in_wishlist %}fill: currentColor;{% endif %}"
                    {% if request.user.is_authenticated and product.in_wishlist %}fill="currentColor"{% endif %}></i>
                </button> {% endcomment %}
            </div>
        </div>
    </div>
</div>